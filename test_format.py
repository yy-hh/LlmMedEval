import requests
import json
import os
question = """## 任务类型：复杂医学推理--临床问诊
任务目标：依据患者的基本信息，分析该患者最可能的诊断及依据，并提出需立即完善的检查。

## 输出要求
- 输出格式应严格保持如下示例格式：
诊断：疾病名称
诊断依据：详细说明诊断的依据，包括症状、体征、实验室检查或影像学特征等。
需立即完善的检查：列出需要立即完善的检查项目。

## 题目和问题
患者女性，58岁，因“腹胀不适5天”入院。5天前无明显诱因出现腹胀不适，伴食欲减退、恶心、干呕，体重减轻3.5kg，无血便、黑便，无腹痛、腹泻，无异常阴道流血、排液，时有腰痛，无尿频、尿急、尿痛、血尿，无低热、盗汗。2023年11月17日于当地人民医院就诊，查肿瘤标志物糖类抗原125（CA125）259U/ml，乳酸脱氢酶（LDH）897U/L；全腹部CT示盆腔组织结构紊乱伴腹盆腔网膜污渍样改变、右侧输尿管及肾积水，左肾囊性病变。2023年11月21日转诊至我院，行阴道彩超检查示：盆腔内增厚、增强条片状回声，较厚处约18mm，范围较广，内可见点条状血流信号；盆腔积液28mm；左侧附件区囊性包块，大小约42mm×41mm×46mm；宫体略大，肌层中探及多个大小不等低回声实性团块。
既往体健，否认手术史，个人史、月经史、婚育史无殊，否认家族史。
体格检查：体温36.4℃，脉搏99次/分，呼吸20次/分，血压168/92mmHg，身高160cm，体重65kg，神志清，精神疲惫，焦虑貌，浅表淋巴结未触及肿大。
妇科检查：外阴已婚已产型，阴道通畅，穹隆变浅，宫颈点状充血，质中，触血阳性；三合诊示子宫后位，宫体不规则增大，盆腔内扪及一直径约10cm质硬包块，形态不规则，边界尚清，与子宫、直肠关系密切，包块固定，活动度欠佳，右侧宫旁间隙变窄，近达盆壁，左侧宫旁间隙尚可，直肠前壁黏膜光滑。
我院实验室检查：血尿常规、凝血四项、肝肾功能、电解质、血糖均无异常；肿瘤标志物：CA125256U/ml，人附睾蛋白4（HE4）133.1pmol/L，绝经前罗马指数（ROMA）49.70%，绝经后罗马指数74.19%，LDH573.8U/L。全腹部CT（平扫+强化）示：肝右叶囊肿、双肾囊肿、胆囊壁厚、右肾周积液；右侧输尿管上段、肾盂扩张，肾灌注不良，考虑子宫肌瘤可能；左下腹部肠管管壁增厚，不除外小肠相关病变；盆腔结构紊乱，子宫双侧旁软组织肿块，盆腔肿大淋巴结，网膜、腹膜增厚，腹、盆腔少量积液。胃肠镜检查示：慢性萎缩性胃炎（木村竹本分类C2），胃窦活检示慢性萎缩性胃炎伴轻度肠上皮化生、部分腺体非典型增生；回盲部见一枚直径约0.5cm息肉，予圈套器冷切除，创面金属夹封闭。宫颈癌筛查：宫颈细胞DNA定量检测可见DNA倍体异常细胞≥3个；HPV分型16型阳性。于2023年11月24日在全身麻醉下行开腹探查术，术中留取腹水送检细胞学，切除左侧附件送检冰冻病理，术后腹水查到小圆细胞恶性肿瘤细胞，石蜡病理回示：（双侧附件、子宫、部分小肠、阑尾、大网膜）非霍奇金高
侵袭性B淋巴瘤。免疫组化：CD3（−），CD20（+），Ki67-MIB1（>90%），CD10（+），Bcl-6（+），Bcl-2（−），MUM-1（−），Pax-5（+），P53（突变型表达），CK（−），CgA（−），EMA（−），Inhibin（−），Calretinin（−），c-Myc（+，70%），CD5（−），TDT（−）。分子原位杂交：EBER（−）。
请分析该患者最可能的诊断及依据，并提出需立即完善的检查。
"""

prompt = "注意：禁止输出json格式结果，直接输出文本/n" + question

json_data = {
    "model": "GPT-5.2",
    "messages": [
        {
            "role": "user",
            "content": prompt,
        }
    ],
    "max_completion_tokens": 5000,
    #"top_k": -1,
    "top_p": 1,
    "temperature": 0,
    #"ignore_eos": False,
    "stream": False,
}

api_key = os.environ.get("ANTMED_API_KEY")

headers = {
    "Authorization": f"Bearer {api_key}",
}

resp = requests.post(
    "https://freeland.openai.azure.com/openai/v1/chat/completions",
    headers=headers,
    json=json_data,
)

print("status:", resp.status_code)
print("raw response text:\n", resp.text)

try:
    data = json.loads(resp.text)
    content_str = data["choices"][0]["message"]["content"]
    print("\nparsed content field (repr):\n", repr(content_str))
except Exception as e:
    print("parse error:", e)